apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# CI overlay for kind clusters

resources:
  - ../../base
  - secrets-ci.yaml  # CI test credentials (overrides base CHANGEME placeholders)

# Override base secrets with CI test credentials
patchesStrategicMerge:
  - secrets-ci.yaml

# Patches for CI
patches:
  # Single replica in CI
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: auth-service
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: backend
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: frontend
  # Vite dev server needs more resources than production builds
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
    target:
      kind: Deployment
      name: frontend

  # Use emptyDir for postgres in CI (no PVC needed)
  - patch: |-
      - op: remove
        path: /spec/volumeClaimTemplates
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: data
            emptyDir: {}
    target:
      kind: StatefulSet
      name: postgres-main
  - patch: |-
      - op: remove
        path: /spec/volumeClaimTemplates
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: data
            emptyDir: {}
    target:
      kind: StatefulSet
      name: postgres-auth

# CI image configuration (built and loaded into kind)
images:
  - name: auth-service
    newName: auth-service
    newTag: ci
  - name: backend
    newName: backend
    newTag: ci
  - name: frontend
    newName: frontend
    newTag: ci
